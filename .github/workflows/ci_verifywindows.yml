name: Verify Windows version

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

jobs:
  verifywindows:
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && github.actor != 'dependabot[bot]'

    steps:
      - name: Download signed Windows binary
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: Lighthouse-win-x64-${{ inputs.version }}
          path: ./publish

      - name: Verify code signature
        shell: powershell
        run: |
          $binary = ".\publish\Lighthouse.exe"
          if (-not (Test-Path $binary)) {
            Write-Error "Error: binary not found at $binary"
            Get-ChildItem .\publish
            exit 1
          }

          Write-Host "Verifying code signature for $binary"
          $signature = Get-AuthenticodeSignature $binary
          
          Write-Host "Signature Status: $($signature.Status)"
          Write-Host "Signer Certificate Subject: $($signature.SignerCertificate.Subject)"
          Write-Host "Signer Certificate Issuer: $($signature.SignerCertificate.Issuer)"
          Write-Host "Timestamp: $($signature.TimeStamperCertificate.NotAfter)"
          
          if ($signature.Status -ne "Valid") {
            Write-Error "Error: Signature status is not Valid"
            exit 1
          }

      - name: Run Lighthouse (sqlite)
        shell: bash
        run: |
          cd publish
          ./Lighthouse.exe > lighthouse.log 2>&1 &
          echo $! > lighthouse.pid
          echo "Started Lighthouse with PID $(cat lighthouse.pid)"
        env:
          Database__Provider: sqlite
          Database__ConnectionString: "Data Source=lighthouse.db"

      - name: Wait for Lighthouse to start
        shell: bash
        run: |
          timeout=60
          elapsed=0
          
          echo "Waiting for service to start..."
          while [ $elapsed -lt $timeout ]; do
            if curl -k -s -f https://localhost:5001 > /dev/null 2>&1; then
              echo "Service is up!"
              exit 0
            fi
            
            # Check if process is still running
            if [ -f publish/lighthouse.pid ]; then
              pid=$(cat publish/lighthouse.pid)
              if ! kill -0 $pid 2>/dev/null; then
                echo "Process died unexpectedly!"
                cat publish/lighthouse.log
                exit 1
              fi
            fi
            
            sleep 2
            elapsed=$((elapsed + 2))
          done
          
          echo "Timeout waiting for service"
          cat publish/lighthouse.log
          exit 1

      - name: Stop Lighthouse Server
        if: always()
        shell: bash
        run: |
          if [ -f publish/lighthouse.pid ]; then
            pid=$(cat publish/lighthouse.pid)
            echo "Stopping process $pid"
            kill $pid 2>/dev/null || true
          fi
          
          # Show logs
          echo "=== Lighthouse Log ==="
          cat publish/lighthouse.log || true