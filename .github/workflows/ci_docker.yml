name: Docker

on:
  workflow_call:
    inputs:
      fileversion:
        required: true
        type: string

jobs:
  docker:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.actor != 'dependabot[bot]'

    permissions:
      packages: write

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: '0'

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 20

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f
        with:
          # Automatically sets up the default builder
          use: true    

      - name: Build and push multi-platform Docker image
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          VERSION=${{ inputs.fileversion }}

          # Define platforms you want to support
          PLATFORMS="linux/amd64,linux/arm64"

          # Build and push the multi-platform image
          docker buildx build --platform $PLATFORMS --no-cache \
            --file Dockerfile \
            --tag ghcr.io/$REPO_NAME:$VERSION \
            --tag ghcr.io/$REPO_NAME:dev-latest \
            --build-arg VERSION=$VERSION \
            --push .

      - name: Pull and verify Docker image
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          VERSION=${{ inputs.fileversion }}
          
          # Pull the amd64 version for testing
          docker pull --platform linux/amd64 ghcr.io/$REPO_NAME:$VERSION

      - name: Run Docker container for health check
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          VERSION=${{ inputs.fileversion }}
          
          # Run container in detached mode with SQLite
          docker run -d --name lighthouse-test \
            -p 443:443 \
            -e Database__Provider=sqlite \
            -e Database__ConnectionString="Data Source=lighthouse.db" \
            ghcr.io/$REPO_NAME:$VERSION

      - name: Wait for Lighthouse to start
        run: |
          echo "Waiting for server to be ready..."
          timeout 30 bash -c 'until curl --silent --fail --insecure https://localhost:443; do sleep 1; done'
          echo "Server is ready!"

      - name: Cleanup test container
        if: always()
        run: |
          echo "Container logs:"
          docker logs lighthouse-test || true
          docker stop lighthouse-test || true
          docker rm lighthouse-test || true