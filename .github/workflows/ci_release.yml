name: Release
on:
  workflow_call:
    inputs:
      fileversion:
        required: true
        type: string
      version:
        required: true
        type: string
jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.actor != 'dependabot[bot]'
    
    environment:
      name: Release
   
    permissions:
      contents: write
      packages: write
      actions: read
      id-token: write
    
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: '0'
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Tag docker image with latest
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker pull ghcr.io/$REPO_NAME:${{ inputs.fileversion }}
          docker tag ghcr.io/$REPO_NAME:${{ inputs.fileversion }} ghcr.io/$REPO_NAME:latest
          docker push ghcr.io/$REPO_NAME:latest
      
          # Install Cosign
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad
      
        # Sign the image using keyless signing (GitHub OIDC)
      - name: Sign Docker image with Cosign
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          cosign sign --yes ghcr.io/$REPO_NAME:${{ inputs.fileversion }}
          cosign sign --yes ghcr.io/$REPO_NAME:latest
      
      - name: Verify the signature
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          cosign verify --certificate-identity="https://github.com/LetPeopleWork/Lighthouse/.github/workflows/ci_release.yml@refs/heads/main" --certificate-oidc-issuer="https://token.actions.githubusercontent.com" ghcr.io/$REPO_NAME:${{ inputs.fileversion }}
          cosign verify --certificate-identity="https://github.com/LetPeopleWork/Lighthouse/.github/workflows/ci_release.yml@refs/heads/main" --certificate-oidc-issuer="https://token.actions.githubusercontent.com" ghcr.io/$REPO_NAME:latest
      
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: Lighthouse-win-x64-${{ inputs.version }}
          path: LighthouseArtifacts/win-x64
          
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: Lighthouse-osx-dmg-${{ inputs.version }}
          path: LighthouseArtifacts/osx-dmg

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: Lighthouse-osx-app-${{ inputs.version }}
          path: LighthouseArtifacts/osx-app

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: Lighthouse-linux-x64-${{ inputs.version }}
          path: LighthouseArtifacts/linux-x64

      - uses: vimtor/action-zip@1379ea20d4c5705669ba81fd626dd01b1c738f26
        with:
          files: LighthouseArtifacts/win-x64
          dest: Lighthouse-win-x64.zip

      - uses: vimtor/action-zip@1379ea20d4c5705669ba81fd626dd01b1c738f26
        with:
          files: LighthouseArtifacts/linux-x64
          dest: Lighthouse-linux-x64.zip

      - name: Prepare macOS release files
        run: |
          cp LighthouseArtifacts/osx-dmg/Lighthouse-${{ inputs.version }}.dmg Lighthouse-osx.dmg
          cp LighthouseArtifacts/osx-app/Lighthouse-${{ inputs.version }}.app.zip Lighthouse-osx.app.zip

      - uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b
        with:
          artifacts: "Lighthouse-win-x64.zip,Lighthouse-osx.dmg,Lighthouse-osx.app.zip,Lighthouse-linux-x64.zip"
          tag: ${{ inputs.version }}
          prerelease: true
          name: "Lighthouse ${{ inputs.version }}"
          token: ${{ secrets.RELEASE_CREATION_TOKEN}}