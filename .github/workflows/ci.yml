name: Build And Deploy Lighthouse

env:
  DOTNET_VERSION: '10'  
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  AzureDevOpsLighthouseIntegrationTestToken: ${{ secrets.AZUREDEVOPSLIGHTHOUSEINTEGRATIONTESTTOKEN }}
  JiraLighthouseIntegrationTestToken: ${{ secrets.JIRALIGHTHOUSEINTEGRATIONTESTTOKEN }}
  AzureDevOpsLighthouseE2ETestToken: ${{secrets.AZUREDEVOPSLIGHTHOUSEE2ETESTTOKEN}}
  LinearAPIKey: ${{ secrets.LINEARAPIKEY }}

on:
  push:
    branches: [ "main", "features/**" ]    
    paths:
      - "Lighthouse.Backend/**"
      - "Lighthouse.Backend.Tests/**"
      - "Lighthouse.EndToEndTests/**"
      - "Lighthouse.Frontend/**"
      - ".github/workflows/ci*.yml"
      - "examples/postgres/**"
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  

jobs:
  changes:
    uses: ./.github/workflows/ci_changes.yml

  backend:
    needs: changes
    uses: ./.github/workflows/ci_backend.yml
    with:
      backend: ${{ needs.changes.outputs.backend }}

  frontend:
    needs: changes
    uses: ./.github/workflows/ci_frontend.yml
    with:
      frontend: ${{ needs.changes.outputs.frontend }}

  e2e:
    needs: changes
    uses: ./.github/workflows/ci_e2e.yml
    with:
      e2e: ${{ needs.changes.outputs.e2e }}

  tag:
    needs: [frontend, backend, e2e]
    uses: ./.github/workflows/ci_tag.yml
    permissions:
      contents: write

  packageapp:
    needs: tag
    uses: ./.github/workflows/ci_packageapp.yml
    permissions:
      actions: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
      version: ${{ needs.tag.outputs.version }}
  
  docker:
    needs: tag
    uses: ./.github/workflows/ci_docker.yml
    permissions:
      packages: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
  
  # Linux verification with EndToEnd tests
  verifysqlite:
    needs: [packageapp, tag]
    uses: ./.github/workflows/ci_verifysqlite.yml
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}
  verifypostgres:
    needs: [packageapp, tag]
    uses: ./.github/workflows/ci_verifypostgres.yml
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}
  
  # macOS signing and verification
  codesign-macos:
    needs: tag
    uses: ./.github/workflows/ci_codesign-macos.yml
    permissions:
      actions: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
      version: ${{ needs.tag.outputs.version }}

  verifymacos:
    needs: [codesign-macos, tag]
    uses: ./.github/workflows/ci_verifymacos.yml
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}
      submission_id: ${{ needs.codesign-macos.outputs.submission_id }}
  
  # Windows signing and verification
  codesign-windows:
    needs: [tag, verifysqlite, verifypostgres]
    uses: ./.github/workflows/ci_codesign-windows.yml
    permissions:
      actions: write
    with:
      version: ${{ needs.tag.outputs.version }}

  verifywindows:
    needs: [codesign-windows, tag]
    uses: ./.github/workflows/ci_verifywindows.yml
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}

  release:
    needs: [tag, docker, verifymacos, verifywindows]
    uses: ./.github/workflows/ci_release.yml
    permissions:
      contents: write
      packages: write
      actions: read
      id-token: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
      version: ${{ needs.tag.outputs.version }}
