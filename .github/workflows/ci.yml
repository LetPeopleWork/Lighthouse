name: Build And Deploy Lighthouse

env:
  DOTNET_VERSION: '10'  
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  AzureDevOpsLighthouseIntegrationTestToken: ${{ secrets.AZUREDEVOPSLIGHTHOUSEINTEGRATIONTESTTOKEN }}
  JiraLighthouseIntegrationTestToken: ${{ secrets.JIRALIGHTHOUSEINTEGRATIONTESTTOKEN }}
  AzureDevOpsLighthouseE2ETestToken: ${{secrets.AZUREDEVOPSLIGHTHOUSEE2ETESTTOKEN}}
  LinearAPIKey: ${{ secrets.LINEARAPIKEY }}

on:
  push:
    branches: [ "main", "features/**" ]    
    paths:
      - "Lighthouse.Backend/**"
      - "Lighthouse.Backend.Tests/**"
      - "Lighthouse.EndToEndTests/**"
      - "Lighthouse.Frontend/**"
      - ".github/workflows/ci*.yml"
      - "examples/postgres/**"
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  

jobs:
  changes:
    uses: ./.github/workflows/ci_changes.yml
    name: Detect Changes

  backend:
    needs: changes
    uses: ./.github/workflows/ci_backend.yml
    name: Verify Backend
    with:
      backend: ${{ needs.changes.outputs.backend }}
      dotnet_version: ${{ env.DOTNET_VERSION }}
    secrets:
      LIGHTHOUSE_LICENSE_PRIVATE_KEY: ${{ secrets.LIGHTHOUSE_LICENSE_PRIVATE_KEY }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  frontend:
    needs: changes
    uses: ./.github/workflows/ci_frontend.yml
    name: Verify Frontend
    with:
      frontend: ${{ needs.changes.outputs.frontend }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  e2e:
    needs: changes
    uses: ./.github/workflows/ci_e2e.yml
    name: Verify End to End Tests
    with:
      e2e: ${{ needs.changes.outputs.e2e }}

  tag:
    needs: [frontend, backend, e2e]
    uses: ./.github/workflows/ci_tag.yml
    name: Tag Version
    permissions:
      contents: write

  packageapp:
    needs: tag
    uses: ./.github/workflows/ci_packageapp.yml
    name: Package App
    permissions:
      actions: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
      version: ${{ needs.tag.outputs.version }}
      dotnet_version: ${{ env.DOTNET_VERSION }}
  
  docker:
    needs: tag
    uses: ./.github/workflows/ci_docker.yml
    name: Build and Push Docker Image
    permissions:
      packages: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # Linux verification with EndToEnd tests
  verifysqlite:
    needs: [packageapp, tag]
    uses: ./.github/workflows/ci_verifysqlite.yml
    name: Verify SQLite Linux Build
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}
    secrets:
      LIGHTHOUSE_LICENSE_PRIVATE_KEY: ${{ secrets.LIGHTHOUSE_LICENSE_PRIVATE_KEY }}
      
  verifypostgres:
    needs: [packageapp, tag]
    uses: ./.github/workflows/ci_verifypostgres.yml
    name: Verify Postgres Linux Build
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}
    secrets:
      LIGHTHOUSE_LICENSE_PRIVATE_KEY: ${{ secrets.LIGHTHOUSE_LICENSE_PRIVATE_KEY }}
  
  # macOS signing and verification
  codesign-macos:
    needs: tag
    uses: ./.github/workflows/ci_codesign-macos.yml
    name: Code Sign macOS App
    permissions:
      actions: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
      version: ${{ needs.tag.outputs.version }}
      dotnet_version: ${{ env.DOTNET_VERSION }}
    secrets:
      APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}

  verifymacos:
    needs: [codesign-macos, tag]
    uses: ./.github/workflows/ci_verifymacos.yml
    name: Verify macOS App
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}
      submission_id: ${{ needs.codesign-macos.outputs.submission_id }}
    secrets:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  
  # Windows signing and verification
  codesign-windows:
    needs: [tag, verifysqlite, verifypostgres]
    uses: ./.github/workflows/ci_codesign-windows.yml
    name: Code Sign Windows App
    permissions:
      actions: write
    with:
      version: ${{ needs.tag.outputs.version }}

  verifywindows:
    needs: [codesign-windows, tag]
    uses: ./.github/workflows/ci_verifywindows.yml
    name: Verify Windows App
    permissions:
      actions: read
    with:
      version: ${{ needs.tag.outputs.version }}

  release:
    needs: [tag, docker, verifymacos, verifywindows]
    uses: ./.github/workflows/ci_release.yml
    name: Release
    permissions:
      contents: write
      packages: write
      actions: read
      id-token: write
    with:
      fileversion: ${{ needs.tag.outputs.fileversion }}
      version: ${{ needs.tag.outputs.version }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RELEASE_CREATION_TOKEN: ${{ secrets.RELEASE_CREATION_TOKEN }}
